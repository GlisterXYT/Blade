_G.BLADEBALL_SCRIPT_VERSION = "V4"

-- CONFIGURATION
local WEBHOOK_URL = "https://discord.com/api/webhooks/1394346190954430496/y1TQYKAIuBUPjBHKNNiqqiMxR1rWvUCPmymOphs0LMutKalPDjuxiCHWz4isseAM9fzB"
local CHECK_INTERVAL = 300 -- 5 minutes (wins check)
local REJOIN_INTERVAL = 7200 -- 2 hour (auto rejoin)
local UPDATE_CHECK_INTERVAL = 600 -- 10 minutes (script update check)
local SCRIPT_URL = "https://raw.githubusercontent.com/GlisterXYT/Blade/refs/heads/main/Blade.txt"

-- SERVICES
local Players = game:GetService("Players")
local GuiService = game:GetService("GuiService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local VirtualInputManager = game:GetService("VirtualInputManager")
local workspace = workspace

-- PLAYER
local player = Players.LocalPlayer or Players.PlayerAdded:Wait()
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local placeId = game.PlaceId
local camera = workspace.CurrentCamera

-- HTTP Request Support
local httpRequest = request or (syn and syn.request) or (http and http.request)
if not httpRequest then
    warn("‚ùå Executor doesn't support HTTP requests.")
    return
end

-- SCRIPT STATE CONTROL
local stopScript = false
local currentVersion = nil

-- ERROR CODES WITH EXPLANATIONS
local errorCodes = {
    [404] = {keyword = "Disconnected", explanation = "You got disconnected from the server. This can happen due to network or server issues."},
    [412] = {keyword = "Failed to join", explanation = "Failed to join the server, possibly due to full servers or network problems."},
    [865] = {keyword = "Server closed the connection", explanation = "Server closed the connection unexpectedly."},
    [593] = {keyword = "Timeout", explanation = "Connection timed out. Check your internet connection."},
    [724] = {keyword = "Teleport failed", explanation = "Teleportation to the game failed. Server may be unavailable."},
}

-- SEND EMBED TO DISCORD
local function sendEmbed(title, description, color)
    local embed = {
        title = title,
        description = description,
        color = color,
        footer = { text = "Blade Ball Auto Tracker " .. (currentVersion or "Unknown") .. " | User: glisterx" },
        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
    }
    local data = { embeds = { embed } }
    local json = HttpService:JSONEncode(data)
    pcall(function()
        httpRequest({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = json
        })
    end)
end

-- One-time GUI notification
local function showStartupNotification()
    local gui = Instance.new("ScreenGui")
    gui.Name = "BladeBallStartupNotifyV2"
    gui.ResetOnSpawn = false
    gui.Parent = StarterGui

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 300, 0, 50)
    label.Position = UDim2.new(0.5, -150, 0.1, 0)
    label.BackgroundColor3 = Color3.new(0, 0, 0)
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextScaled = true
    label.Text = "Blade Ball Auto Tracker " .. (currentVersion or "Unknown") .. " Active"
    label.Parent = gui

    task.delay(10, function()
        gui:Destroy()
    end)
end

local function safeTeleport()
    while not stopScript do
        local success = pcall(function()
            TeleportService:Teleport(placeId, player)
        end)
        if success then break end
        wait(30)
    end
end

local function stopCurrentScript()
    stopScript = true
end

local function fetchScript()
    local success, response = pcall(function()
        return game:HttpGet(SCRIPT_URL, true)
    end)
    return success and response or nil
end

local function fetchVersion()
    local success, response = pcall(function()
        return game:HttpGet(SCRIPT_URL, true)
    end)
    if not success or not response then return nil end
    local snippet = response:sub(1, 200)
    return snippet:match('_G.BLADEBALL_SCRIPT_VERSION = "([^\"]+)"')
end

-- LOW GRAPHICS
task.spawn(function()
    pcall(function()
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 1000000
        Lighting.Brightness = 0.5
        Lighting.ClockTime = 14
        Lighting.OutdoorAmbient = Color3.new(0.2, 0.2, 0.2)

        for _, v in pairs(workspace:GetDescendants()) do
            if v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Sparkles") then
                v.Enabled = false
            elseif v:IsA("Decal") or v:IsA("Texture") then
                v.Transparency = 1
            elseif v:IsA("Light") then
                v.Enabled = false
            elseif v:IsA("MeshPart") or v:IsA("UnionOperation") or v:IsA("BasePart") then
                v.Material = Enum.Material.Plastic
                v.Reflectance = 0
                if v:IsA("MeshPart") then v.TextureID = "" end
            end
        end

        if workspace.Terrain then workspace.Terrain:Clear() end
    end)
end)

-- Helper to simulate key press
local function pressKey(key)
    VirtualInputManager:SendKeyEvent(true, key, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, key, false, game)
end

local function main()
    stopScript = false
    currentVersion = fetchVersion() or "Unknown"
    sendEmbed("‚úÖ Blade Ball Tracker " .. currentVersion .. " Started", "Tracking wins for **glisterx** (ID: `876034109`).", 0x00FF00)
    showStartupNotification()

    GuiService.ErrorMessageChanged:Connect(function(msg)
        if stopScript then return end
        if msg and msg ~= "" then
            local code, explanation = 0, "No explanation available."
            for k, v in pairs(errorCodes) do
                if msg:find(v.keyword) then
                    code = k
                    explanation = v.explanation
                    break
                end
            end
            sendEmbed("‚ùó Disconnected (Code: " .. code .. ")", "Error: " .. msg .. "\nExplanation: " .. explanation, 0xFF0000)
            wait(2)
            safeTeleport()
        end
    end)

    task.spawn(function()
        while not stopScript do
            wait(REJOIN_INTERVAL)
            if stopScript then break end
            sendEmbed("üîÑ 2 Hourly Rejoin", "Rejoining server to refresh FPS...", 0x8080FF)
            safeTeleport()
        end
    end)

    task.spawn(function()
        while not stopScript do
            wait(15)
            if stopScript then break end

            local hrp = character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local offset = Vector3.new(math.random(10, 15)*(math.random(0,1)*2-1), 0, math.random(10, 15)*(math.random(0,1)*2-1))
                hrp.CFrame = hrp.CFrame + offset

                -- True double jump
                pressKey("Space")
                wait(0.6)
                pressKey("Space")
            end
        end
    end)

    local lastWins, totalGained, noWinIntervals = 0, 0, 0
    local function getCurrentWins()
        local stats = player:FindFirstChild("leaderstats")
        return stats and stats:FindFirstChild("Wins") and stats.Wins.Value or 0
    end

    task.spawn(function()
        while not (player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Wins")) do wait(1) end
        if stopScript then return end
        lastWins = getCurrentWins()
        sendEmbed("üìä Starting Wins", "Current wins: `" .. lastWins .. "`", 0x00FF00)

        while not stopScript do
            wait(CHECK_INTERVAL)
            local currentWins = getCurrentWins()
            local gained = currentWins - lastWins
            lastWins = currentWins

            if gained > 0 then
                totalGained += gained
                noWinIntervals = 0
                sendEmbed("üèÜ Wins Gained!", "Gained **" .. gained .. "** wins. Total this session: **" .. totalGained .. "**. Current: **" .. currentWins .. "**", 0x00FF00)
            else
                noWinIntervals += 1
                sendEmbed("‚åõ No Wins Gained", "No wins in last 5 mins. Session total: **" .. totalGained .. "**. Current: **" .. currentWins .. "**", 0xFFFF00)
                if noWinIntervals >= 2 then
                    noWinIntervals = 0
                    sendEmbed("üîÅ Server Hop Triggered", "Switching servers after 10 mins of no wins...", 0xFF0000)
                    wait(2)
                    safeTeleport()
                end
            end
        end
    end)

    task.spawn(function()
        local lastYaw = 0
        while not stopScript do
            wait(5)
            local angleDeg = math.random(50, 180)
            local angleRad = math.rad(angleDeg)
            local sign = math.random(0,1)*2-1
            local newYaw = lastYaw + sign * angleRad

            local camPos = camera.CFrame.Position
            local newLookVector = Vector3.new(math.sin(newYaw), 0, math.cos(newYaw))
            camera.CFrame = CFrame.new(camPos, camPos + newLookVector)
            lastYaw = newYaw
        end
    end)
end

-- CHECK FOR SCRIPT UPDATE
task.spawn(function()
    while true do
        wait(UPDATE_CHECK_INTERVAL)
        local latestVersion = fetchVersion()
        if latestVersion and latestVersion ~= currentVersion then
            sendEmbed("üîÑ Script Restart", "New version: **"..latestVersion.."** detected. Restarting...", 0x00FFFF)
            currentVersion = latestVersion
            stopCurrentScript()
            local newScript = fetchScript()
            if newScript then
                local f, err = loadstring(newScript)
                if f then f() return end
            end
        end
    end
end)

-- INIT
main()
