-- CONFIGURATION
local WEBHOOK_URL = "https://discord.com/api/webhooks/1394346190954430496/y1TQYKAIuBUPjBHKNNiqqiMxR1rWvUCPmymOphs0LMutKalPDjuxiCHWz4isseAM9fzB"
local CHECK_INTERVAL = 300 -- 5 minutes
local REJOIN_INTERVAL = 3600 -- 1 hour

-- SERVICES
local Players = game:GetService("Players")
local GuiService = game:GetService("GuiService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

-- ✅ Get Player
local player = Players.LocalPlayer
if not player then
    player = Players.PlayerAdded:Wait()
end
local placeId = game.PlaceId

-- ✅ HTTP Request Handler
local httpRequest = request or (syn and syn.request) or (http and http.request)
if not httpRequest then
    warn("❌ Your executor doesn't support HTTP requests.")
    return
end

-- ✅ Send Discord Embed
local function sendEmbed(title, description, color)
    local embed = {
        title = title,
        description = description,
        color = color,
        footer = { text = "Blade Ball Auto Tracker | User: glisterx" },
        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
    }
    local data = { embeds = { embed } }
    local jsonData = HttpService:JSONEncode(data)

    local success, res = pcall(function()
        return httpRequest({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = jsonData
        })
    end)

    if not success then
        warn("❌ Webhook failed:", res)
    end
end

-- ✅ Startup Embed
sendEmbed("✅ Blade Ball Tracker Started", "Tracking wins for **glisterx** (ID: `876034109`).", 0x00FF00)

-- ✅ Safe Teleport
local function safeTeleport()
    while true do
        local success = pcall(function()
            TeleportService:Teleport(placeId, player)
        end)
        if success then break end
        wait(30)
    end
end

-- 🔌 Reconnect on disconnect
GuiService.ErrorMessageChanged:Connect(function(msg)
    if msg and msg ~= "" then
        warn("Disconnected: " .. msg)
        sendEmbed("❗ Disconnected", "Player disconnected with message:\n```" .. msg .. "```", 0xFF0000)
        wait(2)
        safeTeleport()
    end
end)

-- 🔁 Auto rejoin every hour
task.spawn(function()
    while true do
        wait(REJOIN_INTERVAL)
        sendEmbed("🔄 Hourly Rejoin", "Rejoining server to refresh FPS...", 0x8080FF)
        safeTeleport()
    end
end)

-- 🏆 Win Tracker + Server Hop Logic
local lastWins = 0
local totalGained = 0
local noWinIntervals = 0

local function getCurrentWins()
    local stats = player:FindFirstChild("leaderstats")
    return stats and stats:FindFirstChild("Wins") and stats.Wins.Value or 0
end

task.spawn(function()
    -- Wait for leaderstats to load
    while not (player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Wins")) do
        wait(1)
    end

    lastWins = getCurrentWins()
    sendEmbed("📊 Starting Wins", "Current wins: `" .. lastWins .. "`", 0x00FF00)

    while true do
        wait(CHECK_INTERVAL)
        local currentWins = getCurrentWins()
        local gained = currentWins - lastWins
        lastWins = currentWins

        if gained > 0 then
            totalGained += gained
            noWinIntervals = 0
            sendEmbed("🏆 Wins Gained!",
                string.format(
                    "You gained **%d** wins in the last 5 minutes.\nTotal wins gained this session: **%d**\nCurrent total wins: **%d**",
                    gained, totalGained, currentWins
                ),
                0x00FF00
            )
        else
            noWinIntervals += 1
            sendEmbed("⌛ No Wins Gained",
                string.format(
                    "No wins gained in the last 5 minutes.\nTotal wins gained this session: **%d**\nCurrent total wins: **%d**",
                    totalGained, currentWins
                ),
                0xFFFF00
            )

            if noWinIntervals >= 2 then
                noWinIntervals = 0
                sendEmbed("🔁 Server Hop Triggered", "No wins in the last 10 minutes. Switching servers...", 0xFF0000)
                wait(2)
                safeTeleport()
            end
        end
    end
end)
